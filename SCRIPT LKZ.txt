-- Serviços do Roblox
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Camera = game:GetService("Workspace").CurrentCamera
local LocalPlayer = Players.LocalPlayer

-- Variável para ativar/desativar ESP
local espEnabled = false

-- Função para criar ESP
local function createESP(player)
    local Box = Drawing.new("Square")
    local Line = Drawing.new("Line")
    
    Box.Visible = false
    Box.Color = Color3.new(1, 0, 0)
    Box.Thickness = 2
    Box.Filled = false
    
    Line.Visible = false
    Line.Color = Color3.new(1, 0, 0)
    Line.Thickness = 2
    
    local function Update()
        while player.Character and player.Character:FindFirstChild("HumanoidRootPart") and player ~= LocalPlayer and espEnabled do
            local HumanoidRootPart = player.Character.HumanoidRootPart
            local RootPartPosition, onScreen = Camera:WorldToViewportPoint(HumanoidRootPart.Position)
            local HeadPosition = Camera:WorldToViewportPoint(HumanoidRootPart.Position + Vector3.new(0, 3, 0))
            local LegPosition = Camera:WorldToViewportPoint(HumanoidRootPart.Position - Vector3.new(0, 3, 0))
            
            if onScreen then
                Box.Size = Vector2.new(2000 / RootPartPosition.Z, 4000 / RootPartPosition.Z)
                Box.Position = Vector2.new(RootPartPosition.X - Box.Size.X / 2, RootPartPosition.Y - Box.Size.Y / 2)
                Box.Visible = true
                
                Line.From = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2)
                Line.To = Vector2.new(RootPartPosition.X, RootPartPosition.Y)
                Line.Visible = true
            else
                Box.Visible = false
                Line.Visible = false
            end
            
            RunService.RenderStepped:Wait()
        end
        Box:Remove()
        Line:Remove()
    end
    
    coroutine.wrap(Update)()
end

-- Função para criar efeito nos pés do jogador
local function createFootEffect(player)
    local character = player.Character
    if not character then return end

    local humanoid = character:FindFirstChild("Humanoid")
    if not humanoid then return end

    local rootPart = humanoid.RootPart
    if not rootPart then return end

    local footPosition = rootPart.Position + Vector3.new(0, -humanoid.HipHeight / 2, 0)
    local footOnScreen, screenPos = Camera:WorldToViewportPoint(footPosition)

    if footOnScreen then
        local size = Vector2.new(30, 30) -- ajustar tamanho conforme necessário
        local effect = Drawing.new("Rectangle")
        effect.Position = screenPos - size / 2
        effect.Size = size
        effect.Color = Color3.fromRGB(0, 255, 0) -- ajustar cor conforme necessário (verde para indicador de amigo)
        effect.Visible = true

        -- Opcional: Mostrar brevemente o efeito
        RunService.Heartbeat:Wait(1) -- ajustar duração conforme necessário
        effect:Remove()
    end
end

-- Função para atualizar ESP
local function updateESP()
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            createESP(player)
            createFootEffect(player)
        end
    end
end

-- Função para alternar ESP
local function toggleESP()
    if espEnabled then
        for _, drawing in pairs(Drawing.GetChildren()) do
            if drawing:IsA("Square") or drawing:IsA("Line") then
                drawing:Remove()
            end
        end
    else
        updateESP()
    end
end

-- UI Library Integration
local UILib = loadstring(game:HttpGet('https://raw.githubusercontent.com/StepBroFurious/Script/main/HydraHubUi.lua'))()
local Window = UILib.new("Grand Piece Online", game.Players.LocalPlayer.UserId, "Buyer")
local Category1 = Window:Category("Main", "http://www.roblox.com/asset/?id=8395621517")
local SubButton1 = Category1:Button("Combat", "http://www.roblox.com/asset/?id=8395747586")
local Section1 = SubButton1:Section("Section", "Left")

-- ESP Toggle Button
Section1:Toggle({
    Title = "ESP",
    Description = "Enable or disable ESP",
    Default = false,
}, function(value)
    espEnabled = value
    toggleESP()
end)

Section1:Button({
    Title = "Kill All",
    ButtonName = "KILL!!",
    Description = "kills everyone",
}, function(value)
    print(value)
end)

Section1:Toggle({
    Title = "Auto Farm Coins",
    Description = "Optional Description here",
    Default = false
}, function(value)
    print(value)
end)

Section1:Slider({
    Title = "Walkspeed",
    Description = "",
    Default = 16,
    Min = 0,
    Max = 120
}, function(value)
    print(value)
end)

Section1:ColorPicker({
    Title = "Colorpicker",
    Description = "",
    Default = Color3.new(255, 0, 0),
}, function(value)
    print(value)
end)

Section1:Textbox({
    Title = "Damage Multiplier",
    Description = "",
    Default = "",
}, function(value)
    print(value)
end)

Section1:Keybind({
    Title = "Kill All",
    Description = "",
    Default = Enum.KeyCode.Q,
}, function(value)
    print(value)
end)

-- Minimize Button
local isMinimized = false

local function toggleMenu()
    isMinimized = not isMinimized
    if isMinimized then
        Window:Minimize()
    else
        Window:Maximize()
    end
end

Category1:Button("Minimize", "http://www.roblox.com/asset/?id=8395747586", function()
    toggleMenu()
end)

-- Initialize ESP
updateESP()

-- Update ESP when new players join
game.Players.PlayerAdded:Connect(function(newPlayer)
    newPlayer.CharacterAdded:Connect(function(character)
        if espEnabled then
            createESP(newPlayer)
            createFootEffect(newPlayer)
        end
    end)
end)

-- Remove ESP when players leave
game.Players.PlayerRemoving:Connect(function(leavingPlayer)
    for _, drawing in pairs(Drawing.GetChildren()) do
        if drawing:IsA("Square") or drawing:IsA("Line") and drawing.Adornee and drawing.Adornee.Parent == leavingPlayer.Character then
            drawing:Remove()
        end
    end
end)
